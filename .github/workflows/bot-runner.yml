name: Run Telegram Bot for 5 Hours

on:
  workflow_dispatch:  # امکان اجرای دستی
  schedule:
    # اجرای خودکار هر روز در ساعت مشخص (اختیاری)
    - cron: '0 12 * * *'

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5 ساعت
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-telegram-bot yt-dlp ffmpeg-python
        
    - name: Create config file
      run: |
        cat > config.py << 'EOF'
        #!/usr/bin/env python3
        import os
        
        # تنظیمات ربات
        BOT_TOKEN = os.environ.get("BOT_TOKEN", "${{ secrets.BOT_TOKEN }}")
        
        # کانال مورد نظر برای عضویت
        CHANNEL_USERNAME = "@down_11_f"
        CHANNEL_LINK = "https://t.me/down_11_f"
        
        # دایرکتوری دانلود
        DOWNLOAD_DIR = "downloads"
        
        # تنظیمات timeout
        UPLOAD_TIMEOUT = 300  # 5 دقیقه برای آپلود فایل‌های بزرگ
        
        # حداکثر حجم فایل (50MB)
        MAX_FILE_SIZE = 50
        
        # تنظیمات yt-dlp
        YT_DLP_OPTIONS = {
            'socket_timeout': 60,
            'retries': 10,
            'fragment_retries': 10,
            'skip_unavailable_fragments': True,
            'keep_fragments': False,
            'noprogress': False,
            'extractor_args': {
                'youtube': {
                    'player_client': ['android', 'web'],
                    'player_skip': ['configs', 'webpage']
                }
            },
            'http_headers': {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                'Accept-Language': 'en-us,en;q=0.5',
                'Accept-Encoding': 'gzip,deflate',
                'Accept-Charset': 'ISO-8859-1,utf-8;q=0.7,*;q=0.7',
                'Connection': 'keep-alive',
            },
        }
        EOF
        
    - name: Run bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        python your_bot_file.py
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: bot-logs
        path: |
          bot.log
          downloads/
        retention-days: 1
